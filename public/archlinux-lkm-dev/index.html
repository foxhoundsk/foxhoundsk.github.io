<!DOCTYPE html>
<html lang="en-us"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">Linux kernel module development in Archlinux based VM | As the universe, so the soul</title>
<meta property="og:title" content="Linux kernel module development in Archlinux based VM | As the universe, so the soul" />
<meta name="twitter:title" content="Linux kernel module development in Archlinux based VM | As the universe, so the soul" />
<meta itemprop="name" content="Linux kernel module development in Archlinux based VM | As the universe, so the soul" />
<meta name="application-name" content="Linux kernel module development in Archlinux based VM | As the universe, so the soul" />
<meta property="og:site_name" content="" />

<meta name="description" content="Linux VM">
<meta itemprop="description" content="Linux VM" />
<meta property="og:description" content="Linux VM" />
<meta name="twitter:description" content="Linux VM" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />

  <link rel="alternate" hreflang="en" href="http://localhost:1313/archlinux-lkm-dev/" title="" />






<meta name="generator" content="Hugo 0.136.3">

    
    <meta property="og:url" content="http://localhost:1313/archlinux-lkm-dev/">
  <meta property="og:site_name" content="As the universe, so the soul">
  <meta property="og:title" content="Linux kernel module development in Archlinux based VM">
  <meta property="og:description" content="Linux VM">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:published_time" content="2024-10-23T00:32:06+08:00">
    <meta property="article:modified_time" content="2024-10-23T00:32:06+08:00">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Linux kernel module development in Archlinux based VM">
  <meta name="twitter:description" content="Linux VM">


    

    <link rel="canonical" href="http://localhost:1313/archlinux-lkm-dev/">
    <link href="/style.min.e390ba7da26222f4dc42a349955d76dbbe44e5ce2535a43de5a70633a0a9ec3c.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    </head>
<body data-theme = "" class="notransition">

<script src="/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js" integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title></title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">Linux kernel module development in Archlinux based VM</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2024-10-23T00:32:06&#43;08:00" itemprop="datePublished"> Oct 23, 2024 </time>
                </div>
                
            </header>
            
            <div class="page-content">
                <p>Linux kernel module (LKM) development is usually conducted inside a VM to prevent corruption of the dev box. Most of the LKM dev. setup guides are targeting Ubuntu based machine, but I love Arch Linux, and there have sparse resources regarding LKM dev. on Archlinux-based VM. So I would like to make a post discussing this. Specifically, I&rsquo;ll discuss how to make the kernel header that is required for out-of-date (no longer present in Pacman latest database) kernel images.</p>
<p>First, Linux requires that the kernel module has the same vermagic comparing to the targeting kernel, which means an appropriate kernel header is required for the module to load successfully. On Archlinux, the <strong>latest</strong> header can be acquired by installing pakage <code>linux-headers</code>. However, due to the fact that the kernel came along with the prebuilt VM image, or the likes, can&rsquo;t usually match the latest header, we often times need to manually download the corresponding header [0].</p>
<p>To download specific kernel header, navigate to:</p>
<p><a href="https://gitlab.archlinux.org/archlinux/packaging/packages/linux">https://gitlab.archlinux.org/archlinux/packaging/packages/linux</a></p>
<p>Choose the git tag of interest and clone the repo, for example:
{% highlight c %}
git clone &ndash;depth 1 &ndash;branch v6.10.8-arch1 <a href="https://github.com/archlinux/linux.git">https://github.com/archlinux/linux.git</a> linux-6.10.8-arch1
{% endhighlight c %}</p>
<p>Afterwards, run <code>makepkg -s</code> [1] to get the artifacts (e.g. Module.symvers) required for building the LKM.</p>
<p>During <code>makepkg</code>, one may encounter an error stating that the PGP key is unknown. To get rid of this, navigate to the header directory [2], then run:
{% highlight c %}
gpg &ndash;import keys/pgp/*
{% endhighlight c %}</p>
<p>In your device driver directory, make changes to the Makefile. Specifically, point <code>KERNEL_SRC</code> (or the likes) to the directory that you just ran <code>makepkg -s</code>. That is, the directory containing artifacts such as <code>Module.symvers</code>.</p>
<p>Now we are good to compile and load the kernel module for our specific kernel. Happy kernel hacking!</p>
<p>[0] One can of course update the kernel to the latest version to solve the version mismatch dilemma, but maybe one would like to stick with a specific kernel release.
[1] <code>-si</code> is also fine if one would like to have the header installed after the build.
[2] The directory containing directory <code>keys</code>.</p>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
</div>
    <small class="footer_copyright">
        © 2024 .
        
    </small>
</footer>







    
    <script src="http://localhost:1313/js/main.min.4ee188e1744c19816e95a540b2650ed9f033ea0371e74eac8e717355cfca8741.js" integrity="sha256-TuGI4XRMGYFulaVAsmUO2fAz6gNx506sjnFzVc/Kh0E="></script>

    

</body>
</html>
